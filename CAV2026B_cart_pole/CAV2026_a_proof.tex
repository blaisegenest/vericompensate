\documentclass[runningheads]{llncs}
\usepackage[T1]{fontenc}

\usepackage[hyphens]{url}  % DO NOT CHANGE THIS
\usepackage{graphicx} % DO NOT CHANGE THIS
\frenchspacing  % DO NOT CHANGE THIS
\usepackage{algorithm}
\usepackage{algorithmic}
\pagestyle{plain}
\usepackage{threeparttable}
\input{math_commands.tex}
\usepackage{lineno}
\usepackage{subcaption}
\usepackage{tabularx}
\usepackage{cases}
\captionsetup{compatibility=false}
\usepackage{epstopdf}
\usepackage{placeins}
\usepackage{pgfplots}
\usepackage{tikz}
\usepackage{calc}
\usepackage{array}
%\usepackage[linesnumbered,ruled,vlined]{algorithm2e}
\usetikzlibrary{positioning, arrows.meta,calc}
\usepackage{newfloat}
\usepackage{listings}
\DeclareCaptionStyle{ruled}{labelfont=normalfont,labelsep=colon,strut=off} % DO NOT CHANGE THIS
\lstset{%
	basicstyle={\footnotesize\ttfamily},% footnotesize acceptable for monospace
	numbers=left,numberstyle=\footnotesize,xleftmargin=2em,% show line numbers, remove this entire line if you don't want the numbers.
	aboveskip=0pt,belowskip=0pt,%
	showstringspaces=false,tabsize=2,breaklines=true}
\floatstyle{ruled}
\newfloat{listing}{tb}{lst}{}
\floatname{listing}{Listing}
%\newtheorem{proposition}{Proposition}
%\newtheorem{definition}{Definition}
\newcommand{\vW}{\boldsymbol{W}}
\newcommand{\val}{{\textrm{value}}}
\newcommand{\Val}{{\textrm{value}}}
\newcommand{\MILP}{{\textrm{MILP}}}
\newcommand{\LP}{{\textrm{LP}}}
\newcommand{\Improve}{\mathrm{Improve}}
\newcommand{\Utility}{\mathrm{SAS}}
\newcommand{\Sol}{\mathrm{Sol}}
\newcommand{\sol}{\mathrm{sol}}
\newcommand{\UB}{\mathrm{UB}}
\newcommand{\LB}{\mathrm{LB}}
\newcommand{\ub}{\mathrm{ub}}
\newcommand{\lb}{\mathrm{lb}}
\newcommand{\B}{\mathrm{B}}
\usepackage{amsmath, amssymb, amsfonts}
\newcommand{\ReLU}{\mathrm{ReLU}}
\newcommand{\CMP}{{\textrm{CMP}}\ }
\newcommand{\fix}{\marginpar{FIX}}
\newcommand{\new}{\marginpar{NEW}}
\newcommand{\toolname}{Hybrid MILP}

\usepackage{bibentry}


\begin{document}


\section{Preliminaries}



We will use $||.||$ as the $L_{\infty}$ distance.
For $\varepsilon>0$ and a set $Y$ of configuration, we define 
$B_\epsilon(Y) = \{z \mid \exists y\in Y, \ ||y-z||<\epsilon \}$
the open ball of distance $\varepsilon$ around $Y$.
A function $f : A \rightarrow 2^B$
is Lipschitz continuous if there exists a constant $\ell$ (Lipschitz constant) such that for any $x,x'$:
 $f(x') \subseteq B_{\ell \cdot ||x'-x||}(f(x))$.


\begin{definition}
		A system $S$ is a 5-tuple $(X,C,succ, U, I)$ with: \begin{itemize}
			\item $X\subseteq \mathbb{R}^n$ is the set of configurations,
			\item The set $C$ is a set of controlled actions,
			\item The successor function $succ: X\times C \rightarrow 2^X \setminus \emptyset$ is a Lipschitz continuous and provides the set $succ(x,c)$ of possible successor when chosing action $c$ from configuration $x$,
			\item The set of unsafe configurations $U\subseteq X$,
			\item and the set of initial configurations $I\subseteq X$, $>\varepsilon$ away from $U$ for some $\varepsilon$,
		\end{itemize}
\end{definition}

\paragraph{Policy}
A policy $\sigma$ for system $S = (X,C,succ, U, I)$ is a function 
$\sigma: X\rightarrow C$. Given $\sigma$, we define 
$succ_\sigma: X\rightarrow 2^X$ by $succ_\sigma(x) = succ(x,\sigma(x))$.
A run under $\sigma$ is a sequence $(x_i)_{i \in \mathbb{N}}$ such that
$x_0 \in I$ and for all $i \geq 0$, $x_{i+1} \in succ_p(x_i)$.
We define $Reach^S(\sigma) = \{x \mid \exists i, (x_n)_{n \in \mathbb{N}} \text{ a run under } \sigma, x_i=x\}$ the set of state reachable by $\sigma$ in $S$ (in particular from initial states $I$ of $S$).



If $\sigma$ is provided as a decision tree where each leave $i$ is associated with a Lipschitz continuous function $f_i$, then it descirbes a piecewise Lipschitz continuous funciton $f$, and we can $\sigma$ a 
piecewise Lipschitz continuous DT.

\paragraph{Perturbed system}


\begin{definition}
	For a system $S=(X,C,succ,U,I)$, we define its 
	$\delta$-perturbation $S_\delta = (X,C, succ_\delta,U,I)$, where: 
		$succ_\delta(x,c) = (succ(B_\delta(x),c))$.
	A policy $\sigma$ of $S$ is also a policy for $S_\delta$.
	We defined $Reach^S_\delta(\sigma) = Reach^{S_\delta}(\sigma)$.
\end{definition}



A policy $\sigma$ of $S$ is said to be {\em safe} if $Reach^S(\sigma) \cup U = \emptyset$. Policy $\sigma$ is {\em $\delta$-robustly safe} if 
$Reach_\delta^S(\sigma) \cup U = \emptyset$, and $\sigma$ is {\em robustly safe}
if it is {\em $\delta$-robustly safe} for some $\delta>0$.


\paragraph{Certificate}


\begin{definition}
	A certificate for policy $\sigma$ of system $S=(X,C,succ,U,I)$ is a function 
	$f : X \rightarrow \{0,1\}$ such that:
	\begin{itemize}
		\item $I \subseteq f^{-1}(1)$, 
		
		\item $f^{-1}(1)\cap U = \emptyset$,
		
		\item For any $x,x' \in X$ such that $f(x)=1$ and $x' \in succ_p(x)$,
		we have $f(x')=1$.
\end{itemize}
If $f$ is providede as a DT, where leaves are associated with $\{0,1\}$,
then $f$ is called a DT-certificate.
\end{definition}
	

\section{Results}

\begin{theorem}
	If a piecewise Lipschitz continuous DT policy $p$ is robustly safe, then
	there exists a DT-certificate for safety. 

	If a piecewise Lipschitz continuous axis aligned DT policy $p$ is robustly safe, then there exists a axis aligned DT-certificate for safety. 

	If a ReLU-DNN policy $p$ is robustly safe, then
	there exists a ReLU-DNN certificate for safety. 
\end{theorem}

Let $\sigma$ be a piecewise Lipschitz-continuous policy for system $S=(X,C,succ,U,I)$ which is $\delta$-robustly safe for $\delta>0$.
Let $R_\varepsilon=Reach^S_\varepsilon(\sigma)$ for all $\varepsilon$.
It means that $R_\delta \cap U = \emptyset$.

Consider $R = B_{\delta/4}(R_{\delta/2})$.
We show that $R$ satisfies:
$R_{\delta_2} \subsetneq R \subsetneq R_\delta$ 
with:
\begin{itemize}
	\item $I \subseteq R$,
	\item $B_{\delta/4}(R)\cup U = \emptyset$,
	meaning that $R$ is away from $U$,
	\item For all polytope $P$ on which 
    $\sigma$ is Liptscitz continuous (say with function $f$),
	for all $x \in P \cup R_{\delta/2}$ and 
	$y$ with $||y-x||<\delta/4$, 
	$succ(y,f(y)) \in R_{\delta/2}$.
\end{itemize}

IT will be sufficient to obtain a DT certificate.
Only the third item above is non trivial.

Without loss of generality, we assume the Lipschitz constant for $succ$ is 1.


\begin{lemma}
	There exists a finite polytopes decompose of $X=\bigcup_{i\in I,\ I\text{ is finite}} Q_i$ (they may include or exclude their boundaries) and Lipschitz continuous functions $f_i$ assigned for each polytopes that can define $p$:\begin{align*}
		p(x) = f_i(x)\quad \text{if }x\in Q_i
	\end{align*}
\end{lemma}

\begin{proof}
	This is because $p$ is a piecewise  Lipschitz continuous DT policy.
\end{proof}


\begin{lemma}
	There exists $\varepsilon >0$ such that $R_{\delta/2}(I)$ is attractive in the region $\bigcup_{i\in I}B_\varepsilon(R_{\delta/2}(I)\cap Q_i)\cap Q_i$.
\end{lemma}

\begin{proof}
	We use $R_i$ to denote each $R_{\delta/2}(I)\cap Q_i$.	By assumption, each $Q_i$ is assigned with a Lipschitz continuous function $f_i$ with Lipschitz constant $K_i$. Let $K = \max_{i\in I} K_i$ and $\varepsilon = \frac{\delta}{2K+2} < \delta/2$ (for $L_\infty$ distance; for other distance as $L_2$, $L_1$, $\varepsilon$ should be smaller). 
	
	For a point $y$ in $B_\varepsilon(R_i)\cap Q_i$, there exists $x\in R_i\subseteq Q_i$ such that $d(x,y)<\varepsilon$. We consider $succ_p(y)$ and $succ_p(x)$. 
	
	Since $x,y\in Q_i$, $d(p(x),p(y))\leq K_i d(x,y) < K \varepsilon<\delta/2$.  By assumptions, we have $succ_p(y)\subseteq B_{\delta/2}(succ_p(x))$. Because $x\in R_i\subseteq R_{\delta/2}(I)$, by definition, we have that $succ_p(y)\subseteq R_{\delta/2}(I)$.
	
	This is what we want to show.
\end{proof}


\begin{lemma}
	There is a region $A$ satisfying the following:
	\begin{itemize}
			\item A is a union of polytopes.
		\item $A\supseteq R_{\delta/2}(I)$
		\item $A\subseteq\bigcup_{i\in I}B_\varepsilon(R_{\delta/2}(I)\cap Q_i)\cap Q_i$
	\end{itemize}
	Hence, from $A$ we can construct a DT certificate.
\end{lemma}


%\begin{lemma}
%	Let $S$ be a system with policy $p$ and initial region $I$. For any $x\in R_r(I)$ and any $\varepsilon$, we have
%	\[
%	B_\varepsilon(x) \subseteq R_{r+\varepsilon }(I).
%	\]
%	Hence $B_\varepsilon(R_r(I)) \subseteq R_{r+\varepsilon}(I)$.
%\end{lemma}
%
%\begin{proof}
%	To prove this lemma, fix $x \in R_r(I)$.
%	
%	We assume $x = x_{n+1}$ and $x_{n+1} = p(x_n)+d_n$ with $|d_n|<r$ and $x_n\in R_r(I)\cup I\subseteq R_{r+\varepsilon}(I)\cup I$. Then, we have \[
%	B_{\varepsilon}(x) \subseteq B_{|d_n| + \varepsilon}(p(x_n)) \subseteq B_{r + \varepsilon}(p(x_n)).
%	\]
%	
%	By definition, since $x_n\in R_{r+\varepsilon}(I)\cup I$, $B_{r + \varepsilon}(p(x_n))\subseteq R_{r+\varepsilon}(I)$.
%	So,
%	\[
%B_{\varepsilon}(x) \subseteq
%	B_{r + \varepsilon}(p(x_n))\subseteq R_{r+\varepsilon}(I).
%	\]
%	This completes the proof.
%\end{proof}
%
%\vspace*{2ex}
%
%Notice that if $B_\varepsilon(R_r(I)) \subseteq R_{r+\varepsilon}(I)$, then $\operatorname{cl}(R_r(I)) \subseteq \operatorname{int}(R_{r+\varepsilon}(I))$. 
%
%\begin{proof}[of Theorem 1]
%	
%	We assume that $S$ is $\delta$-robustly safe.
%	
%	From Lemma 1, we can see that \begin{itemize}
%		\item $\operatorname{cl}(R(I)) \subseteq \operatorname{int}(R_\delta(I))$.
%		
%		\item Every point in $R(I)$ is at least a distance $\delta$ away from the boundary of $R_\delta(I)$.
%	\end{itemize}   
%	
%	
%	Therefore, we can partition the space into hypercubes of side length $\frac{\delta}{2\sqrt{n}}$ where $n$ is the dimension, and cover $R(I)$ with these hypercubes. Those hypercubes are in $R_\delta(I)$, and even $R_{\delta/2}(I)$.
%	
%	Put them together, we can get the following conclusion:
%	\begin{itemize}
%		\item There is a union of polytopes $\bigcup_{P \in \mathcal{P}} P$ contained in   $R_{\delta}(I)$ that covers $R(I)$.
%
%		\item Any point start from $\bigcup_{P \in \mathcal{P}} P$ following $S$ without perturbation will never enter $U$, and has a minimal distance from $U$.
%	\end{itemize}
%\end{proof}





\end{document}
